<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Spotify Downloader üéµ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <style>
    @keyframes gradientBG {
      0% {background-position: 0% 50%;}
      50% {background-position: 100% 50%;}
      100% {background-position: 0% 50%;}
    }
    body {
      background: linear-gradient(-45deg, #1db954, #121212, #191414, #0f0f0f);
      background-size: 400% 400%;
      animation: gradientBG 15s ease infinite;
      font-family: 'Roboto', sans-serif;
      overflow-x: hidden;
    }
    ::-webkit-scrollbar {
      width: 6px;
    }
    ::-webkit-scrollbar-thumb {
      background: #1db954;
      border-radius: 10px;
    }
    canvas#webgl-bg {
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      z-index: -2;
    }
  </style>
</head>
<body class="text-white min-h-screen flex flex-col">
  <canvas id="webgl-bg"></canvas>

  <div class="flex flex-1 flex-col md:flex-row overflow-hidden">
    <aside class="bg-black/50 backdrop-blur-lg p-4 md:p-6 w-full md:w-60 shadow-md">
      <h1 class="text-3xl font-bold text-green-500 mb-8">Spotify</h1>
    </aside>

    <main class="flex-1 p-4 md:p-10 overflow-y-auto">
      <div class="w-full max-w-3xl mx-auto bg-white/5 p-6 md:p-8 rounded-2xl shadow-lg backdrop-blur-md hover:scale-[1.01] transition-all duration-300">
        <h2 class="text-3xl font-bold mb-6 text-green-400">üé∂ Download or Play Your Favorite Song</h2>

        <form id="downloadForm" class="space-y-4">
          <input type="text" id="query" placeholder="Enter song name..." required
            class="w-full p-4 rounded-full bg-gray-800 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-green-500" />
          <button type="submit"
            class="w-full sm:w-auto bg-green-500 hover:bg-green-600 transition-all px-6 py-3 rounded-full font-semibold hover:shadow-xl">
            Search
          </button>
        </form>

        <div id="progressBarContainer" class="mt-6 hidden">
          <div class="text-sm text-white mb-2">Download Progress</div>
          <div class="w-full bg-gray-700 rounded-full h-4 overflow-hidden">
            <div id="progressBar" class="bg-green-500 h-full transition-all duration-300" style="width: 0%"></div>
          </div>
          <div id="progressStatus" class="text-sm text-gray-300 mt-2"></div>
        </div>

        <div id="result" class="mt-8 space-y-4"></div>
        <div id="log" class="mt-10 p-4 bg-black/40 border border-gray-700 rounded-lg overflow-y-auto max-h-52 text-sm font-mono whitespace-pre-wrap"></div>
      </div>
    </main>
  </div>

  <script>
    const form = document.getElementById('downloadForm');
    const resultDiv = document.getElementById('result');
    const logDiv = document.getElementById('log');
    const progressBar = document.getElementById('progressBar');
    const progressStatus = document.getElementById('progressStatus');
    const progressBarContainer = document.getElementById('progressBarContainer');

    // Server-Sent Events setup
    const evtSource = new EventSource("/progress-stream");
    evtSource.onmessage = function (event) {
      const message = event.data;
      logDiv.textContent += message + "\n";
      logDiv.scrollTop = logDiv.scrollHeight;

      if (message.includes("Starting")) {
        progressBar.style.width = "0%";
        progressStatus.textContent = "Starting...";
      } else if (message.toLowerCase().includes("error")) {
        progressStatus.textContent = "‚ö†Ô∏è Error occurred...";
      } else if (message.toLowerCase().includes("complete") || message.toLowerCase().includes("file ready")) {
        progressBar.style.width = "100%";
        progressStatus.textContent = "‚úÖ Download complete";
      } else {
        // Optional: estimate progress bar visually
        const width = Math.min(progressBar.clientWidth + 5, progressBar.parentElement.clientWidth);
        progressBar.style.width = `${width}px`;
        progressStatus.textContent = message;
      }
    };

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const query = document.getElementById('query').value;
      resultDiv.innerHTML = `<div class="text-yellow-400 animate-pulse">üîç Searching for matches...</div>`;

      const res = await fetch('/search', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `query=${encodeURIComponent(query)}`
      });

      const data = await res.json();
      resultDiv.innerHTML = '';

      if (data.status === 'success') {
        resultDiv.innerHTML = `<p class="font-semibold text-green-400 mb-2">üéµ Choose a song:</p>`;

        data.choices.forEach((track) => {
          const container = document.createElement('div');
          container.className = "bg-gray-800 p-4 rounded-lg shadow flex flex-col gap-2";

          const name = document.createElement('p');
          name.textContent = track.name;
          name.className = "text-white font-semibold mb-2";

          const downloadBtn = document.createElement('button');
          downloadBtn.textContent = "‚¨á Download";
          downloadBtn.className = "bg-green-500 hover:bg-green-600 px-4 py-2 rounded-lg font-semibold transition-all";

          const streamBtn = document.createElement('button');
          streamBtn.textContent = "‚ñ∂ Play";
          streamBtn.className = "bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded-lg font-semibold transition-all";

          const audio = document.createElement('audio');
          audio.controls = true;
          audio.className = "mt-2 w-full hidden";

          downloadBtn.onclick = async () => {
            resultDiv.innerHTML = `<div class="text-yellow-400 animate-pulse">‚è≥ Downloading \"${track.name}\"...</div>`;
            progressBarContainer.classList.remove('hidden');
            progressBar.style.width = '0%';
            progressStatus.textContent = 'Starting...';
            logDiv.textContent = '';

            const downloadRes = await fetch('/download', {
              method: 'POST',
              headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
              body: `url=${encodeURIComponent(track.url)}`
            });

            const downloadData = await downloadRes.json();
            if (downloadData.status === 'success') {
              resultDiv.innerHTML = `‚úÖ Download ready: <a class="text-green-400 underline" href="${downloadData.download_url}" target="_blank">${downloadData.file}</a>`;
            } else {
              resultDiv.innerHTML = `<span class="text-red-400">‚ùå Error: ${downloadData.message}</span>`;
            }
          };

          streamBtn.onclick = async () => {
            streamBtn.disabled = true;
            streamBtn.textContent = "üéß Loading...";

            const streamRes = await fetch('/stream', {
              method: 'POST',
              headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
              body: `url=${encodeURIComponent(track.url)}`
            });

            const streamData = await streamRes.json();
            if (streamData.status === 'success') {
              audio.src = streamData.stream_url;
              audio.classList.remove('hidden');
              streamBtn.textContent = "‚ñ∂ Play Again";
              streamBtn.disabled = false;
            } else {
              resultDiv.innerHTML = `<span class="text-red-400">‚ùå Stream Error: ${streamData.message}</span>`;
              streamBtn.textContent = "‚ñ∂ Play";
              streamBtn.disabled = false;
            }

            const logs = await fetch('/logs');
            const logText = await logs.json();
            logDiv.textContent = logText.join('\n');
          };

          container.appendChild(name);
          container.appendChild(downloadBtn);
          container.appendChild(streamBtn);
          container.appendChild(audio);
          resultDiv.appendChild(container);
        });
      } else {
        resultDiv.innerHTML = `<span class="text-red-400">‚ùå Error: ${data.message}</span>`;
      }
    });

    const canvas = document.getElementById('webgl-bg');
    const ctx = canvas.getContext('2d');
    let w, h;

    function resizeCanvas() {
      w = canvas.width = window.innerWidth;
      h = canvas.height = window.innerHeight;
    }
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    const dots = Array.from({ length: 120 }).map(() => ({
      x: Math.random() * w,
      y: Math.random() * h,
      r: Math.random() * 1.5 + 0.5,
      vx: Math.random() * 0.5 - 0.25,
      vy: Math.random() * 0.5 - 0.25
    }));

    function draw() {
      ctx.clearRect(0, 0, w, h);
      for (let d of dots) {
        d.x += d.vx;
        d.y += d.vy;
        if (d.x < 0 || d.x > w) d.vx *= -1;
        if (d.y < 0 || d.y > h) d.vy *= -1;
        ctx.beginPath();
        ctx.arc(d.x, d.y, d.r, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(30,215,96,0.7)';
        ctx.fill();
      }
      requestAnimationFrame(draw);
    }
    draw();
  </script>
</body>
</html>
